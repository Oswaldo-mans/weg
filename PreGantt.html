<!DOCTYPE html> <!-- NO PASES DE AQUI -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROYECTO - GANTT</title>
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <link rel="stylesheet" href="Menu2.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Contenedor para aplicar el zoom -->
    <div style="transform: scale(0.8); transform-origin: top left; width: 125%;">
    <!-- NOMBRE DE LA PAGINA -->
    <div id="Titulo" class="g-container">
        <h1>CLIENTE: <span id="clientName" class="client-name"></span></h1>
    </div>

    <!-- MENU INTERACTIVO -->
    <div id="MenuG" class="s-container">
        <div class="ganttM">
            <ul>
                <li id="menu-gantt" style="--clr: #2483ff;">
                    <a href="#">
                        <i class="fa-solid fa-chart-gantt"></i>
                        <span>Gantt</span>
                    </a>
                </li>
                <li id="Kanba" style="--clr: #2483ff;">
                    <a href="#">
                        <i class="fa-solid fa-users"></i>
                        <span>Panel</span>
                    </a>
                </li>
                <li id="Graficos" style="--clr: #2483ff;">
                    <a href="#">
                        <i class="fa-solid fa-chart-pie"></i>
                        <span>Graficos</span>
                    </a>
                </li>
                <li id="Reportes" style="--clr: #2483ff;">
                    <a href="#">
                        <i class="fa-solid fa-file"></i>
                        <span>Reportes</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <button id="toggleLockButton" onclick="toggleLock()">B</button>


    <div id="gantt_chart" style="width: 121.7vw; height: 100vh;"></div>
    <script>
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientName = urlParams.get('clientName');
            const totalItems = parseInt(urlParams.get('totalItems'));
            const clientOrder = urlParams.get('clientOrder');
            const options = JSON.parse(urlParams.get('options'));
            const idItems = JSON.parse(urlParams.get('idItems'));
            const idColumna = JSON.parse(urlParams.get('idColumna'));
            const difficulty = JSON.parse(urlParams.get('difficulty'));
            const date = JSON.parse(urlParams.get('date'));
            const dateF = JSON.parse(urlParams.get('dateF'));

            document.getElementById('clientName').textContent = clientName;

            const storedDurationsKey = 'taskDurations_' + clientName;
            const storedDurations = JSON.parse(localStorage.getItem(storedDurationsKey)) || {};

            const lockStateKey = 'lockState_' + clientName;
            let lockState = localStorage.getItem(lockStateKey) === 'true';

            const storedIdealStartDatesKey = 'idealStartDates_' + clientName;
            const storedIdealEndDatesKey = 'idealEndDates_' + clientName;
            let idealStartDates = JSON.parse(localStorage.getItem(storedIdealStartDatesKey)) || {};
            let idealEndDates = JSON.parse(localStorage.getItem(storedIdealEndDatesKey)) || {};

            const storedStartDatesKey = 'startDates_' + clientName;
            const storedEndDatesKey = 'endDates_' + clientName;
            let startDates = JSON.parse(localStorage.getItem(storedStartDatesKey)) || {};
            let endDates = JSON.parse(localStorage.getItem(storedEndDatesKey)) || {};

            const storedChecklistKey = 'checklist_' + clientName;
            let storedChecklist = JSON.parse(localStorage.getItem(storedChecklistKey)) || {};

            const storedResponsibleKey = 'responsible_' + clientName;
            let storedResponsible = JSON.parse(localStorage.getItem(storedResponsibleKey)) || {};

            function toggleLock() {
            lockState = !lockState;
            localStorage.setItem(lockStateKey, lockState);
            document.getElementById('toggleLockButton').textContent = lockState ? 'D' : 'B';

            if (lockState) {
                gantt.eachTask(function(task) {
                    if (task.$level === 1) {
                        const subTaskName = task.text.split(".- ")[1];
                        if (["Fabricación", "Reporte de pruebas FAT", "Reporte de pruebas (Rutina o Dossier)"].includes(subTaskName)) {
                            idealStartDates[task.id] = task.start_date;
                            idealEndDates[task.id] = task.end_date;
                        }
                    } else if (task.$level === 2) {
                        const subTaskName = task.text.split(".- ")[1];
                        if (["Arribo de materiales - RIPA", "Arribo de materiales - LISTA"].includes(subTaskName)) {
                            idealEndDates[task.id] = task.end_date;
                        }
                    }
                });
                localStorage.setItem(storedIdealStartDatesKey, JSON.stringify(idealStartDates));
                localStorage.setItem(storedIdealEndDatesKey, JSON.stringify(idealEndDates));
            }

            gantt.refreshData();
        }

        document.getElementById('toggleLockButton').textContent = lockState ? 'D' : 'B';
        document.getElementById('toggleLockButton').addEventListener('click', toggleLock);
            // DEFINICION DE DIAS FIJOS - DURACIÓN FIJA
            const fixedDurations = {
                "Aceptación de proyecto": 1,
                "Documentos para aprobación": 3,
                "Aprobación - cliente": 5,
                "Liberación - RIPA": 2,
                "Analizar RIPA": 3,
                "Reporte de fecha RIPA": 3,
                "Liberación - lista": 6,
                "Liberación de WORKFLOW": 2,
                "Analizar lista": 4,
                "Reporte de fecha - lista": 4,
                "Documentos para fabricación": 1,
                "Asignación de rutas": 2,
                "Fabricación": 1,
                "Reporte de pruebas FAT": 1,
                "Reporte de pruebas (Rutina o Dossier)": 3
            };

            // CONFIGURACION DEL LIGHTBOX
            gantt.config.xml_date = "%Y-%m-%d %H:%i";
            gantt.config.lightbox.sections = [
                { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
                { name: "time", height: 72, type: "duration", map_to: "auto" },
                { name: "responsible", height: 20, map_to: "responsible", type: "select", options: [
                    { key: "AREA", label: "AREA" },
                ] }
            ];
            gantt.locale.labels.section_description = "Tarea";
            gantt.locale.labels.section_time = "Duración";
            gantt.locale.labels.section_responsible = "Responsable";

            // NOMBRE PARA ALGUNAS COLUMNAS
            gantt.config.columns = gantt.config.columns.map(column => {
                switch (column.name) {
                    case "text":
                        return { name: "text", label: "ACTIVIDAD", tree: true, width: 300 };
                    case "start_date":
                        return { name: "start_date", label: "INICIO/REAL", align: "center", width: 80 };
                    case "duration":
                        return { name: "duration", label: "DURACIÓN", align: "center", width: 53 };
                    default:
                        return column;
                }
            });
            // CHECKBOX
            gantt.config.columns.unshift(
                { name: "checklist", label: "✔ ✘", width: 25, template: function(task) {
                    const checked = storedChecklist[task.id] ? 'checked' : '';
                    return '<input type="checkbox" class="task-checkbox" data-task-id="' + task.id + '" '+ checked + '>';
                }}
            );
            // COLUMNA DE INICIO/IDEAL
            gantt.config.columns.push({
                name: "new_start_date",
                label: "INICIO/IDEAL",
                align: "center",
                width: 78,
                template: function(task) {
                    if (lockState && ["Fabricación", "Reporte de pruebas FAT", "Reporte de pruebas (Rutina o Dossier)"].includes(task.text.split(".- ")[1])) {
                        return gantt.templates.date_grid(new Date(idealStartDates[task.id]));
                    }
                    if (task.$level === 0) {
                        return gantt.templates.date_grid(task.start_date);
                    } else {  
                        if (["Fabricación", "Reporte de pruebas FAT", "Reporte de pruebas (Rutina o Dossier)"].includes(task.text.split(".- ")[1])) {
                            return gantt.templates.date_grid(task.start_date);
                        }
                        return gantt.templates.date_grid(task.originalStartDate);
                    }
                }
            });
            gantt.config.columns.splice(2, 0, gantt.config.columns.pop());
            // COLUMNAS DE FIN/IDEAL
            gantt.config.columns.push({
                name: "new_end_date",
                label: "FIN/IDEAL",
                align: "center",
                width: 78,
                template: function(task) {
                    if (lockState && ["Fabricación", "Reporte de pruebas FAT", "Reporte de pruebas (Rutina o Dossier)", "Arribo de materiales - RIPA", "Arribo de materiales - LISTA"].includes(task.text.split(".- ")[1])) {
                        const originalEndDate = new Date(idealEndDates[task.id]);
                        originalEndDate.setDate(originalEndDate.getDate() - 1);
                        if (originalEndDate.getDay() === 0) {
                            originalEndDate.setDate(originalEndDate.getDate() - 2);
                        }
                        return gantt.templates.date_grid(originalEndDate);
                    }
                    if (task.$level === 0) {
                        const dateFormatted = gantt.templates.date_grid(new Date(task.original_end_date));
                        return `<span title="FECHA OFERTADA CON EL CLIENTE" style="font-size: inherit; text-decoration: underline; text-decoration-color: #0ac40a;">${dateFormatted}</span>`;
                    } else {
                        if (["Fabricación", "Reporte de pruebas FAT", "Reporte de pruebas (Rutina o Dossier)", "Arribo de materiales - RIPA", "Arribo de materiales - LISTA"].includes(task.text.split(".- ")[1])) {
                            const endDate = gantt.calculateEndDate(task.start_date, task.duration);
                            endDate.setDate(endDate.getDate() - 1);
                            if (endDate.getDay() === 0) {
                                endDate.setDate(endDate.getDate() - 2);
                            }
                            return gantt.templates.date_grid(endDate);
                        }
                        if (task.originalEndDate) {
                            const originalEndDate = new Date(task.originalEndDate);
                            originalEndDate.setDate(originalEndDate.getDate() - 1);
                            if (originalEndDate.getDay() === 0) {
                                originalEndDate.setDate(originalEndDate.getDate() - 2);
                            }
                            const originalEndDateFormatted = gantt.templates.date_grid(originalEndDate);
                            return originalEndDateFormatted;
                        }
                        return gantt.templates.date_grid(task.end_date);
                    }
                }
            });
            gantt.config.columns.splice(3, 0, gantt.config.columns.pop());
            // COLUMNA DE IDEAL - CALCULO DE PORCENTAJES
            // COLUMNA DE IDEAL - CALCULO DE PORCENTAJES
            gantt.config.columns.push({
                name: "establecido",
                label: "IDEAL",
                align: "center",
                width: 60,
                template: function(task) {
                    if (task.hasOwnProperty('idealProgress')) {
                        return task.idealProgress + '%';
                    }

                    const taskPercentages = {
                        "Aceptación de proyecto": 1,
                        "Documentos para aprobación": 5,
                        "Aprobación - cliente": 2,
                        "Liberación - RIPA": 4,
                        "Analizar RIPA": 1,
                        "Reporte de fecha RIPA": 10,
                        "Liberación - lista": 16,
                        "Liberación de WORKFLOW": 1,
                        "Analizar lista": 1,
                        "Reporte de fecha - lista": 20,
                        "Documentos para fabricación": 6,
                        "Asignación de rutas": 1,
                        "Fabricación": 30,
                        "Reporte de pruebas FAT": 1,
                        "Reporte de pruebas (Rutina o Dossier)": 1
                    };

                    if (task.$level === 0) {
                        const subtasks = gantt.getChildren(task.id);
                        let totalProgress = 0;

                        subtasks.forEach(subtaskId => {
                            const subtask = gantt.getTask(subtaskId);
                            const taskName = subtask.text.split(".- ")[1];
                            let progressPercentage;

                            if (lockState && ["Fabricación", "Reporte de pruebas FAT", "Reporte de pruebas (Rutina o Dossier)"].includes(taskName)) {
                                const startDate = new Date(idealStartDates[subtask.id]);
                                const endDate = new Date(idealEndDates[subtask.id]);
                                const today = new Date();
                                const totalDays = calculateTotalDays(startDate, endDate) - 1; // Restar un día del total
                                const elapsedDays = calculateTotalDays(startDate, today);
                                const taskPercentage = taskPercentages[taskName] || 100;
                                progressPercentage = (elapsedDays / totalDays) * taskPercentage;
                            } else {
                                const startDate = new Date(subtask.originalStartDate);
                                const endDate = new Date(subtask.originalEndDate);
                                endDate.setDate(endDate.getDate() - 1);
                                if (endDate.getDay() === 0) {
                                    endDate.setDate(endDate.getDate() - 2);
                                }
                                const today = new Date();
                                const elapsedIdealDays = Math.min(calculateTotalDays(startDate, today), calculateTotalDays(startDate, endDate));
                                const duration = fixedDurations[taskName] || 0;
                                const taskPercentage = taskPercentages[taskName] || 100;
                                progressPercentage = (elapsedIdealDays / duration) * taskPercentage;
                            }

                            totalProgress += Math.min(progressPercentage, taskPercentages[taskName] || 100);
                        });

                        task.idealProgress = totalProgress.toFixed(2);
                        return task.idealProgress + '%';
                    } else {
                        const taskName = task.text.split(".- ")[1];
                        let progressPercentage;

                        if (lockState && ["Fabricación", "Reporte de pruebas FAT", "Reporte de pruebas (Rutina o Dossier)"].includes(taskName)) {
                            const startDate = new Date(idealStartDates[task.id]);
                            const endDate = new Date(idealEndDates[task.id]);
                            const today = new Date();
                            const totalDays = calculateTotalDays(startDate, endDate) - 1; // Restar un día del total
                            const elapsedDays = calculateTotalDays(startDate, today);
                            const taskPercentage = taskPercentages[taskName] || 100;
                            progressPercentage = (elapsedDays / totalDays) * taskPercentage;
                        } else {
                            const startDate = new Date(task.originalStartDate);
                            const endDate = new Date(task.originalEndDate);
                            endDate.setDate(endDate.getDate() - 1);
                            if (endDate.getDay() === 0) {
                                endDate.setDate(endDate.getDate() - 2);
                            }
                            const today = new Date();
                            const elapsedIdealDays = Math.min(calculateTotalDays(startDate, today), calculateTotalDays(startDate, endDate));
                            const duration = fixedDurations[taskName] || 0;
                            const taskPercentage = taskPercentages[taskName] || 100;
                            progressPercentage = (elapsedIdealDays / duration) * taskPercentage;
                        }

                        task.idealProgress = Math.min(progressPercentage, taskPercentages[taskName] || 100).toFixed(2);
                        return task.idealProgress + '%';
                    }
                }
            });
            gantt.config.columns.splice(4, 0, gantt.config.columns.pop());
            // COLUMNA DE FIN/REAL
            gantt.config.columns.push(
                { name: "end_date", label: "FIN/REAL", align: "center", width: 80, template: function(task) {
                    const endDate = gantt.calculateEndDate(task.start_date, task.duration);
                    endDate.setDate(endDate.getDate() - 1);

                    if (endDate.getDay() === 0) {
                        endDate.setDate(endDate.getDate() - 2);
                    }

                    return gantt.templates.date_grid(endDate);
                }}
            );
            gantt.config.columns.splice(7, 0, gantt.config.columns.pop());
            // COLUMNAS DE REAL - CALCULO DE PORCENTAJE
            gantt.config.columns.push(
                { name: "real", label: "REAL", align: "center", width: 60, template: function(task) {
                    if (task.$level === 0) {
                        const subtasks = gantt.getChildren(task.id);
                        let totalProgress = 0;

                        subtasks.forEach(subtaskId => {
                            const subtask = gantt.getTask(subtaskId);
                            const startDate = subtask.start_date;
                            const endDate = new Date(subtask.end_date);
                            endDate.setDate(endDate.getDate() - 1);

                            const today = new Date();
                            const totalRealDays = calculateTotalDays(startDate, endDate);
                            const elapsedRealDays = calculateTotalDays(startDate, today);
                            let taskPercentage = 100;

                            if (subtask.text.includes("Aceptación de proyecto")) {
                                taskPercentage = 1;
                            } else if (subtask.text.includes("Documentos para aprobación")) {
                                taskPercentage = 5;
                            } else if (subtask.text.includes("Aprobación - cliente")) {
                                taskPercentage = 2;
                            } else if (subtask.text.includes("Liberación - RIPA")) {
                                taskPercentage = 4;
                            } else if (subtask.text.includes("Analizar RIPA")) {
                                taskPercentage = 1;
                            } else if (subtask.text.includes("Reporte de fecha RIPA")) {
                                taskPercentage = 10;
                            } else if (subtask.text.includes("Liberación - lista")) {
                                taskPercentage = 16;
                            } else if (subtask.text.includes("Liberación de WORKFLOW")) {
                                taskPercentage = 1;
                            } else if (subtask.text.includes("Analizar lista")) {
                                taskPercentage = 1;
                            } else if (subtask.text.includes("Reporte de fecha - lista")) {
                                taskPercentage = 20;
                            } else if (subtask.text.includes("Documentos para fabricación")) {
                                taskPercentage = 6;
                            } else if (subtask.text.includes("Asignación de rutas")) {
                                taskPercentage = 1;
                            } else if (subtask.text.includes("Fabricación")) {
                                taskPercentage = 30;
                            } else if (subtask.text.includes("Reporte de pruebas FAT")) {
                                taskPercentage = 1;
                            } else if (subtask.text.includes("Reporte de pruebas (Rutina o Dossier)")) {
                                taskPercentage = 1;
                            }

                            const progressPercentage = (elapsedRealDays / totalRealDays) * taskPercentage;
                            totalProgress += Math.min(progressPercentage, taskPercentage);
                        });

                        return totalProgress.toFixed(2) + '%';
                    } else {
                        const startDate = task.start_date;
                        const endDate = new Date(task.end_date);
                        endDate.setDate(endDate.getDate() - 1);

                        const today = new Date();
                        const totalRealDays = calculateTotalDays(startDate, endDate);
                        const elapsedRealDays = calculateTotalDays(startDate, today);
                        let taskPercentage = 100;

                        if (task.text.includes("Aceptación de proyecto")) {
                            taskPercentage = 1;
                        } else if (task.text.includes("Documentos para aprobación")) {
                            taskPercentage = 5;
                        } else if (task.text.includes("Aprobación - cliente")) {
                            taskPercentage = 2;
                        } else if (task.text.includes("Liberación - RIPA")) {
                            taskPercentage = 4;
                        } else if (task.text.includes("Analizar RIPA")) {
                            taskPercentage = 1;
                        } else if (task.text.includes("Reporte de fecha RIPA")) {
                            taskPercentage = 10;
                        } else if (task.text.includes("Liberación - lista")) {
                            taskPercentage = 16;
                        } else if (task.text.includes("Liberación de WORKFLOW")) {
                            taskPercentage = 1;
                        } else if (task.text.includes("Analizar lista")) {
                            taskPercentage = 1;
                        } else if (task.text.includes("Reporte de fecha - lista")) {
                            taskPercentage = 20;
                        } else if (task.text.includes("Documentos para fabricación")) {
                            taskPercentage = 6;
                        } else if (task.text.includes("Asignación de rutas")) {
                            taskPercentage = 1;
                        } else if (task.text.includes("Fabricación")) {
                            taskPercentage = 30;
                        } else if (task.text.includes("Reporte de pruebas FAT")) {
                            taskPercentage = 1;
                        } else if (task.text.includes("Reporte de pruebas (Rutina o Dossier)")) {
                            taskPercentage = 1;
                        }

                        const progressPercentage = (elapsedRealDays / totalRealDays) * taskPercentage;
                        return Math.min(progressPercentage, taskPercentage).toFixed(2) + '%';
                    }
                }}
            );
            gantt.config.columns.splice(8, 0, gantt.config.columns.pop());
            // COLUMNA DE RESPONSABLE
            gantt.config.columns.push(
                { name: "responsible", label: "RESPONSABLE", align: "center", width: 85, template: function(task) {
                    return task.responsible || "";
                }}
            );
            gantt.config.columns.splice(9, 0, gantt.config.columns.pop());
            // ANCHO DE LA COLUMNA ACTIVIDAD
            const taskNameColumn = gantt.config.columns.find(column => column.name === "text");
            taskNameColumn.width = 300;
            //ASIGNACION DE RESPONSABLES
            const taskResponsibles = {
                AREA: [" ", "CLEON", "FGARRIDO", "FERMIN", "ANTONIO", "BAHENA", "ALANIZC", "SAYALA", "FLORESA", "DANIELABH", "JANETMO", "CRUZ", "YOVANI", "WEG"]
            };

            function calculateEndDateWithoutWeekends(startDate, duration) {
                let current = new Date(startDate);
                let daysAdded = 0;
                while (daysAdded < duration) {
                    current.setDate(current.getDate() + 1);
                    if (current.getDay() !== 0 && current.getDay() !== 6) {
                        daysAdded++;
                    }
                }
                return current;
            }

            function adjustDateForWeekends(date, isIncreasing) {
                if (isIncreasing) {
                    while (date.getDay() === 0 || date.getDay() === 6) {
                        date.setDate(date.getDate() + 1);
                    }
                } else {
                    while (date.getDay() === 0 || date.getDay() === 6) {
                        date.setDate(date.getDate() - 1);
                    }
                }
                return date;
            }
            // FUNCION PARA CALCULAR LOS DIAS PASADOS ENTRE FECHAS
            function calculateTotalDays(startDate, endDate) {
                let totalDays = 0;
                const current = new Date(startDate);

                while (current <= endDate) {
                    if (current.getDay() !== 0 && current.getDay() !== 6) {
                        totalDays++;
                    }
                    current.setDate(current.getDate() + 1);
                }

                return totalDays;
            }
            // CARGA DE DATOS AL GANTT
            const data = [];
            for (let i = 0; i < totalItems; i++) {
                const taskName = "Tablero " + (i + 1) + ": " + options[i];
                const idItem = idItems[i];

                const subTaskName1 = idItem + ".- Aceptación de proyecto";
                const subTaskName2 = idItem + ".- Documentos para aprobación";
                const subTaskName3 = idItem + ".- Aprobación - cliente";
                const subTaskName4 = idItem + ".- Liberación - RIPA";
                const subTaskName5 = idItem + ".- Analizar RIPA";
                const subTaskName6 = idItem + ".- Reporte de fecha RIPA";
                const subTaskName7 = idItem + ".- Liberación - lista";
                const subTaskName8 = idItem + ".- Liberación de WORKFLOW";
                const subTaskName9 = idItem + ".- Analizar lista";
                const subTaskName10 = idItem + ".- Reporte de fecha - lista";
                const subTaskName11 = idItem + ".- Documentos para fabricación";
                const subTaskName12 = idItem + ".- Asignación de rutas";
                const subTaskName13 = idItem + ".- Fabricación";
                const subTaskName14 = idItem + ".- Reporte de pruebas FAT";
                const subTaskName15 = idItem + ".- Reporte de pruebas (Rutina o Dossier)";

                const subTaskName16 = idItem + ".- Arribo de materiales - RIPA";
                const subTaskName17 = idItem + ".- Arribo de materiales - LISTA"

                const startDate = calculateEndDateWithoutWeekends(new Date(date[i]), 1);
                const EndDate = calculateEndDateWithoutWeekends(new Date(dateF[i]), 1);

                const AEndDateFixed = calculateEndDateWithoutWeekends(startDate, fixedDurations[subTaskName1] || 1);
                const BEndDateFixed = calculateEndDateWithoutWeekends(AEndDateFixed, fixedDurations[subTaskName2] || 3);
                const CEndDateFixed = calculateEndDateWithoutWeekends(BEndDateFixed, fixedDurations[subTaskName3] || 5);
                const DEndDateFixed = calculateEndDateWithoutWeekends(CEndDateFixed, fixedDurations[subTaskName4] || 2);
                const EEndDateFixed = calculateEndDateWithoutWeekends(DEndDateFixed, fixedDurations[subTaskName5] || 3);
                const FEndDateFixed = calculateEndDateWithoutWeekends(EEndDateFixed, fixedDurations[subTaskName6] || 3);
                const GEndDateFixed = calculateEndDateWithoutWeekends(FEndDateFixed, fixedDurations[subTaskName7] || 6);
                const HEndDateFixed = calculateEndDateWithoutWeekends(GEndDateFixed, fixedDurations[subTaskName8] || 2);
                const IEndDateFixed = calculateEndDateWithoutWeekends(HEndDateFixed, fixedDurations[subTaskName9] || 4);
                const JEndDateFixed = calculateEndDateWithoutWeekends(IEndDateFixed, fixedDurations[subTaskName10] || 4);
                const KEndDateFixed = calculateEndDateWithoutWeekends(JEndDateFixed, fixedDurations[subTaskName11] || 1);
                const LEndDateFixed = calculateEndDateWithoutWeekends(KEndDateFixed, fixedDurations[subTaskName12] || 2);
                const MEndDateFixed = calculateEndDateWithoutWeekends(LEndDateFixed, fixedDurations[subTaskName13] || 1);
                const NEndDateFixed = calculateEndDateWithoutWeekends(MEndDateFixed, fixedDurations[subTaskName14] || 1);
                const ÑEndDateFixed = calculateEndDateWithoutWeekends(NEndDateFixed, fixedDurations[subTaskName15] || 3);

                const AEndDateReal = calculateEndDateWithoutWeekends(startDate, storedDurations[subTaskName1] || 1);
                const BEndDateReal = calculateEndDateWithoutWeekends(AEndDateReal, storedDurations[subTaskName2] || 3);
                const CEndDateReal = calculateEndDateWithoutWeekends(BEndDateReal, storedDurations[subTaskName3] || 5);
                const DEndDateReal = calculateEndDateWithoutWeekends(CEndDateReal, storedDurations[subTaskName4] || 2);
                const EEndDateReal = calculateEndDateWithoutWeekends(DEndDateReal, storedDurations[subTaskName5] || 3);
                const FEndDateReal = calculateEndDateWithoutWeekends(EEndDateReal, storedDurations[subTaskName6] || 3);
                const GEndDateReal = calculateEndDateWithoutWeekends(FEndDateReal, storedDurations[subTaskName7] || 6);
                const HEndDateReal = calculateEndDateWithoutWeekends(GEndDateReal, storedDurations[subTaskName8] || 2);
                const IEndDateReal = calculateEndDateWithoutWeekends(HEndDateReal, storedDurations[subTaskName9] || 4);
                const JEndDateReal = calculateEndDateWithoutWeekends(IEndDateReal, storedDurations[subTaskName10] || 4);
                const KEndDateReal = calculateEndDateWithoutWeekends(JEndDateReal, storedDurations[subTaskName11] || 1);
                const LEndDateReal = calculateEndDateWithoutWeekends(KEndDateReal, storedDurations[subTaskName12] || 2);
                const MEndDateReal = calculateEndDateWithoutWeekends(LEndDateReal, storedDurations[subTaskName13] || 1);
                const NEndDateReal = calculateEndDateWithoutWeekends(MEndDateReal, storedDurations[subTaskName14] || 1);
                const ÑEndDateReal = calculateEndDateWithoutWeekends(NEndDateReal, storedDurations[subTaskName15] || 3);

                    // Calculaciones para subtask_16
                const startSubtask16Fixed = calculateEndDateWithoutWeekends(FEndDateFixed);
                const endSubtask16Fixed = calculateEndDateWithoutWeekends(new Date(LEndDateFixed)); // Cambio aquí
                const startSubtask16Real = calculateEndDateWithoutWeekends(FEndDateReal);
                const endSubtask16Real = calculateEndDateWithoutWeekends(new Date(LEndDateReal)); // Cambio aquí

                // Calculaciones para subtask_17
                const startSubtask17Fixed = calculateEndDateWithoutWeekends(JEndDateFixed);
                const endSubtask17Fixed = calculateEndDateWithoutWeekends(new Date(LEndDateFixed));
                const startSubtask17Real = calculateEndDateWithoutWeekends(JEndDateReal);
                const endSubtask17Real = calculateEndDateWithoutWeekends(new Date(LEndDateReal));

                const colorClass = "gantt_task_color_" + ((i % 5) + 1);

                data.push(
                    {
                        id: "task" + i,
                        text: taskName,
                        start_date: startDates["task" + i] ? new Date(startDates["task" + i]) : startDate,
                        end_date: endDates["task" + i] ? new Date(endDates["task" + i]) : EndDate,
                        responsible: storedResponsible["task" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["task" + i] || [],
                        original_end_date: EndDate
                    },
                    {
                        id: "subtask_0" + i,
                        text: subTaskName1,
                        start_date: startDates["subtask_0" + i] ? new Date(startDates["subtask_0" + i]) : startDate,
                        parent: "task" + i,
                        end_date: endDates["subtask_0" + i] ? new Date(endDates["subtask_0" + i]) : AEndDateReal,
                        responsible: storedResponsible["subtask_0" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_0" + i] || [],
                        duration: storedDurations[subTaskName1] || 1,
                        originalStartDate: startDate,
                        originalEndDate: AEndDateFixed
                    },
                    {
                        id: "subtask_2" + i,
                        text: subTaskName2,
                        start_date: startDates["subtask_2" + i] ? new Date(startDates["subtask_2" + i]) : calculateEndDateWithoutWeekends(AEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_2" + i] ? new Date(endDates["subtask_2" + i]) : BEndDateReal,
                        responsible: storedResponsible["subtask_2" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_2" + i] || [],
                        duration: storedDurations[subTaskName2] || 3,
                        originalStartDate: calculateEndDateWithoutWeekends(AEndDateFixed, 0),
                        originalEndDate: BEndDateFixed
                    },
                    {
                        id: "subtask_3" + i,
                        text: subTaskName3,
                        start_date: startDates["subtask_3" + i] ? new Date(startDates["subtask_3" + i]) : calculateEndDateWithoutWeekends(BEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_3" + i] ? new Date(endDates["subtask_3" + i]) : CEndDateReal,
                        responsible: storedResponsible["subtask_3" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_3" + i] || [],
                        duration: storedDurations[subTaskName3] || 5,
                        originalStartDate: calculateEndDateWithoutWeekends(BEndDateFixed, 0),
                        originalEndDate: CEndDateFixed
                    },
                    {
                        id: "subtask_4" + i,
                        text: subTaskName4,
                        start_date: startDates["subtask_4" + i] ? new Date(startDates["subtask_4" + i]) : calculateEndDateWithoutWeekends(CEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_4" + i] ? new Date(endDates["subtask_4" + i]) : DEndDateReal, 
                        responsible: storedResponsible["subtask_4" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_4" + i] || [],
                        duration: storedDurations[subTaskName4] || 2,
                        originalStartDate: calculateEndDateWithoutWeekends(CEndDateFixed, 0),
                        originalEndDate: DEndDateFixed
                    },
                    {
                        id: "subtask_5" + i,
                        text: subTaskName5,
                        start_date: startDates["subtask_5" + i] ? new Date(startDates["subtask_5" + i]) : calculateEndDateWithoutWeekends(DEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_5" + i] ? new Date(endDates["subtask_5" + i]) : EEndDateReal, 
                        responsible: storedResponsible["subtask_5" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_5" + i] || [],
                        duration: storedDurations[subTaskName5] || 3,
                        originalStartDate: calculateEndDateWithoutWeekends(DEndDateFixed, 0),
                        originalEndDate: EEndDateFixed
                    },
                    {
                        id: "subtask_6" + i,
                        text: subTaskName6,
                        start_date: startDates["subtask_6" + i] ? new Date(startDates["subtask_6" + i]) : calculateEndDateWithoutWeekends(EEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_6" + i] ? new Date(endDates["subtask_6" + i]) : FEndDateReal, 
                        responsible: storedResponsible["subtask_6" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_6" + i] || [],
                        duration: storedDurations[subTaskName6] || 3,
                        originalStartDate: calculateEndDateWithoutWeekends(EEndDateFixed, 0),
                        originalEndDate: FEndDateFixed
                    },
                    {
                        id: "subtask_16" + i,
                        text: subTaskName16,
                        start_date: startDates["subtask_16" + i] ? new Date(startDates["subtask_16" + i]) : startSubtask16Real,
                        parent: "subtask_6" + i,
                        end_date: endDates["subtask_16" + i] ? new Date(endDates["subtask_16" + i]) : endSubtask16Real, 
                        responsible: storedResponsible["subtask_16" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_16" + i] || [],
                        duration: storedDurations[subTaskName16],
                        originalStartDate: startSubtask16Fixed,
                        originalEndDate: endSubtask16Fixed
                    },
                    {
                        id: "subtask_7" + i,
                        text: subTaskName7,
                        start_date: startDates["subtask_7" + i] ? new Date(startDates["subtask_7" + i]) : calculateEndDateWithoutWeekends(FEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_7" + i] ? new Date(endDates["subtask_7" + i]) : GEndDateReal, 
                        responsible: storedResponsible["subtask_7" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_7" + i] || [],
                        duration: storedDurations[subTaskName7] || 6,
                        originalStartDate: calculateEndDateWithoutWeekends(FEndDateFixed, 0),
                        originalEndDate: GEndDateFixed
                    },
                    {
                        id: "subtask_8" + i,
                        text: subTaskName8,
                        start_date: startDates["subtask_8" + i] ? new Date(startDates["subtask_8" + i]) : calculateEndDateWithoutWeekends(GEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_8" + i] ? new Date(endDates["subtask_8" + i]) : HEndDateReal, 
                        responsible: storedResponsible["subtask_8" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_8" + i] || [],
                        duration: storedDurations[subTaskName8] || 2,
                        originalStartDate: calculateEndDateWithoutWeekends(GEndDateFixed, 0),
                        originalEndDate: HEndDateFixed
                    },
                    {
                        id: "subtask_9" + i,
                        text: subTaskName9,
                        start_date: startDates["subtask_9" + i] ? new Date(startDates["subtask_9" + i]) : calculateEndDateWithoutWeekends(HEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_9" + i] ? new Date(endDates["subtask_9" + i]) : IEndDateReal, 
                        responsible: storedResponsible["subtask_9" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_9" + i] || [],
                        duration: storedDurations[subTaskName9] || 4,
                        originalStartDate: calculateEndDateWithoutWeekends(HEndDateFixed, 0),
                        originalEndDate: IEndDateFixed
                    },
                    {
                        id: "subtask_10" + i,
                        text: subTaskName10,
                        start_date: startDates["subtask_10" + i] ? new Date(startDates["subtask_10" + i]) : calculateEndDateWithoutWeekends(IEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_10" + i] ? new Date(endDates["subtask_10" + i]) : JEndDateReal, 
                        responsible: storedResponsible["subtask_10" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_10" + i] || [],
                        duration: storedDurations[subTaskName10] || 4,
                        originalStartDate: calculateEndDateWithoutWeekends(IEndDateFixed, 0),
                        originalEndDate: JEndDateFixed
                    },
                    {
                        id: "subtask_17" + i,
                        text: subTaskName17,
                        start_date: startDates["subtask_17" + i] ? new Date(startDates["subtask_17" + i]) : startSubtask17Real,
                        parent: "subtask_10" + i,
                        end_date: endDates["subtask_17" + i] ? new Date(endDates["subtask_17" + i]) : endSubtask17Real, 
                        responsible: storedResponsible["subtask_17" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_17" + i] || [],
                        duration: storedDurations[subTaskName17],
                        originalStartDate: startSubtask17Fixed,
                        originalEndDate: endSubtask17Fixed
                    },
                    {
                        id: "subtask_11" + i,
                        text: subTaskName11,
                        start_date: startDates["subtask_11" + i] ? new Date(startDates["subtask_11" + i]) : calculateEndDateWithoutWeekends(JEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_11" + i] ? new Date(endDates["subtask_11" + i]) : KEndDateReal, 
                        responsible: storedResponsible["subtask_11" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_11" + i] || [],
                        duration: storedDurations[subTaskName11] || 1,
                        originalStartDate: calculateEndDateWithoutWeekends(JEndDateFixed, 0),
                        originalEndDate: KEndDateFixed
                    },
                    {
                        id: "subtask_12" + i,
                        text: subTaskName12,
                        start_date: startDates["subtask_12" + i] ? new Date(startDates["subtask_12" + i]) : calculateEndDateWithoutWeekends(KEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_12" + i] ? new Date(endDates["subtask_12" + i]) : LEndDateReal, 
                        responsible: storedResponsible["subtask_12" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_12" + i] || [],
                        duration: storedDurations[subTaskName12] || 2,
                        originalStartDate: calculateEndDateWithoutWeekends(KEndDateFixed, 0),
                        originalEndDate: LEndDateFixed
                    },
                    {
                        id: "subtask_13" + i,
                        text: subTaskName13,
                        start_date: startDates["subtask_13" + i] ? new Date(startDates["subtask_13" + i]) : calculateEndDateWithoutWeekends(LEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_13" + i] ? new Date(endDates["subtask_13" + i]) : MEndDateReal, 
                        responsible: storedResponsible["subtask_13" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_13" + i] || [],
                        duration: storedDurations[subTaskName13] || 1,
                        originalStartDate: calculateEndDateWithoutWeekends(LEndDateFixed, 0),
                        originalEndDate: MEndDateFixed
                    },
                    {
                        id: "subtask_14" + i,
                        text: subTaskName14,
                        start_date: startDates["subtask_14" + i] ? new Date(startDates["subtask_14" + i]) : calculateEndDateWithoutWeekends(MEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_14" + i] ? new Date(endDates["subtask_14" + i]) : NEndDateReal, 
                        responsible: storedResponsible["subtask_14" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_14" + i] || [],
                        duration: storedDurations[subTaskName14] || 1,
                        originalStartDate: calculateEndDateWithoutWeekends(MEndDateFixed, 0),
                        originalEndDate: NEndDateFixed
                    },
                    {
                        id: "subtask_15" + i,
                        text: subTaskName15,
                        start_date: startDates["subtask_15" + i] ? new Date(startDates["subtask_15" + i]) : calculateEndDateWithoutWeekends(NEndDateReal, 0),
                        parent: "task" + i,
                        end_date: endDates["subtask_15" + i] ? new Date(endDates["subtask_15" + i]) : ÑEndDateReal, 
                        responsible: storedResponsible["subtask_15" + i] || "",
                        css: colorClass,
                        checklist: storedChecklist["subtask_15" + i] || [],
                        duration: storedDurations[subTaskName15] || 3,
                        originalStartDate: calculateEndDateWithoutWeekends(NEndDateFixed, 0),
                        originalEndDate: ÑEndDateFixed
                    }
                );
            }

            // Añadir dependencias entre subtareas
            const links = [];
            for (let i = 0; i < totalItems; i++) {
                links.push(
                    { id: i * 17 + 1, source: "subtask_0" + i, target: "subtask_2" + i, type: "0" },
                    { id: i * 17 + 2, source: "subtask_2" + i, target: "subtask_3" + i, type: "0" },
                    { id: i * 17 + 3, source: "subtask_3" + i, target: "subtask_4" + i, type: "0" },
                    { id: i * 17 + 4, source: "subtask_4" + i, target: "subtask_5" + i, type: "0" },
                    { id: i * 17 + 5, source: "subtask_5" + i, target: "subtask_6" + i, type: "0" },
                    { id: i * 17 + 6, source: "subtask_6" + i, target: "subtask_7" + i, type: "0" },
                    { id: i * 17 + 7, source: "subtask_7" + i, target: "subtask_8" + i, type: "0" },
                    { id: i * 17 + 8, source: "subtask_8" + i, target: "subtask_9" + i, type: "0" },
                    { id: i * 17 + 9, source: "subtask_9" + i, target: "subtask_10" + i, type: "0" },
                    { id: i * 17 + 10, source: "subtask_10" + i, target: "subtask_11" + i, type: "0" },
                    { id: i * 17 + 11, source: "subtask_11" + i, target: "subtask_12" + i, type: "0" },
                    { id: i * 17 + 12, source: "subtask_12" + i, target: "subtask_13" + i, type: "0" },
                    { id: i * 17 + 13, source: "subtask_13" + i, target: "subtask_14" + i, type: "0" },
                    { id: i * 17 + 14, source: "subtask_14" + i, target: "subtask_15" + i, type: "0" },
                    { id: i * 17 + 15, source: "subtask_16" + i, target: "subtask_13" + i, type: "0" },
                    { id: i * 17 + 16, source: "subtask_17" + i, target: "subtask_13" + i, type: "0" }
                );
            }
            gantt.config.work_time = true;
            gantt.config.skip_off_time = true;

            // Configuración de escalas de tiempo en español
            gantt.config.scales = [
                { unit: "month", step: 1, format: "%F %Y" },
                { unit: "week", step: 1, format: function(date) {
                    var dateToStr = gantt.date.date_to_str("%d %M");
                    var endDate = gantt.date.add(date, -6, "day");
                    var weekNum = gantt.date.date_to_str("%W")(date);
                    return "Semana " + weekNum;
                } },
                { unit: "day", step: 1, format: "%d" }
            ];

            // Nombres de meses y días en español
            gantt.locale.date.month_full = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            // Ajuste del ancho de las celdas y altura de la escala
            gantt.config.min_column_width = 18; // Ancho mínimo de las celdas
            gantt.config.scale_height = 60; // Altura total de la escala de tiempo

            gantt.init("gantt_chart");
            gantt.parse({ data, links });
            gantt.templates.task_class = function(start, end, task) {
                return task.css;
            };
            //PARA RECALCULAR LA DURACION EN LA TAREA PADRE - DES SUS SUBTAREAS
            function updateParentDuration(parentTaskId) {
                if (!gantt.isTaskExists(parentTaskId)) {
                    return;
                }
                const subtasks = gantt.getChildren(parentTaskId);
                let totalDuration = 0;
                subtasks.forEach(subtaskId => {
                    const subtask = gantt.getTask(subtaskId);
                    totalDuration += subtask.duration;
                });
                const parentTask = gantt.getTask(parentTaskId);
                parentTask.duration = totalDuration;
                gantt.refreshTask(parentTaskId);

                const endDate = gantt.calculateEndDate(parentTask.start_date, parentTask.duration);
                endDate.setDate(endDate.getDate() - 1);
                if (endDate.getDay() === 0) {
                    endDate.setDate(endDate.getDate() - 2);
                }
                parentTask.end_date = endDate;
                gantt.refreshTask(parentTaskId);
            }

            const tasks = gantt.getTaskByTime();
            tasks.forEach(task => {
                if (!task.parent) {
                    updateParentDuration(task.id);
                }
            });

            gantt.attachEvent("onGanttRender", function() {
                const tasks = gantt.getTaskByTime();
                tasks.forEach(task => {
                    if (!task.parent) {
                        updateParentDuration(task.id);
                    }
                });

                document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const taskId = this.dataset.taskId;
                        const task = gantt.getTask(taskId);
                        task.checklist = this.checked;
                        storedChecklist[taskId] = this.checked;
                        localStorage.setItem(storedChecklistKey, JSON.stringify(storedChecklist));
                        gantt.refreshTask(taskId);
                    });
                });
            });
            // SI ALGUNA SUBTAREA ES ACTUALIZADA - SUS FECHAS DE INICIO Y FIN CAMBIARAN: COMO DEPENDENCIAS
            gantt.attachEvent("onAfterTaskUpdate", function(taskId, task) {
            const isIncreasing = task.end_date > task.start_date;
            const taskDuration = task.duration;

            // ARRAY
            storedDurations[task.text] = taskDuration;
            localStorage.setItem(storedDurationsKey, JSON.stringify(storedDurations));

            // Guardar la nueva fecha de inicio y fin en localStorage
            startDates[taskId] = task.start_date;
            endDates[taskId] = task.end_date;
            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

            // Excluir subtareas 16 y 17 de la actualización automática de duraciones
            if (taskId.includes("subtask_16") || taskId.includes("subtask_17")) {
                return;
            }

            //SI LA SUBTAREA ACTUALIZADA ES LA 1
            if (taskId.includes("subtask_0")) {
                            
                const task2Id = taskId.replace("subtask_0", "subtask_2");
                const task2 = gantt.getTask(task2Id);
                const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task2.text] || 3), isIncreasing);
                if (task2) {
                    task2.start_date = newStartDate;
                    task2.end_date = newEndDate;
                    gantt.refreshTask(task2Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task2Id] = task2.start_date;
                    endDates[task2Id] = task2.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                    
                    const task3Id = task2Id.replace("subtask_2", "subtask_3");
                    const task3 = gantt.getTask(task3Id);
                    if (task3) {
                        const task3StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newEndDate, 0), isIncreasing);
                        const task3EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task3StartDate, storedDurations[task3.text] || 5), isIncreasing);
                        task3.start_date = task3StartDate;
                        task3.end_date = task3EndDate;
                        gantt.refreshTask(task3Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task3Id] = task3.start_date;
                        endDates[task3Id] = task3.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                    
                        const task4Id = task3Id.replace("subtask_3", "subtask_4");
                        const task4 = gantt.getTask(task4Id);
                        if (task4) {
                            const task4StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task3EndDate, 0), isIncreasing);
                            const task4EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task4StartDate, storedDurations[task4.text] || 2), isIncreasing);
                            task4.start_date = task4StartDate;
                            task4.end_date = task4EndDate;
                            gantt.refreshTask(task4Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task4Id] = task4.start_date;
                            endDates[task4Id] = task4.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                    
                            const task5Id = task4Id.replace("subtask_4", "subtask_5");
                            const task5 = gantt.getTask(task5Id);
                            if (task5) {
                                const task5StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task4EndDate, 0), isIncreasing);
                                const task5EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task5StartDate, storedDurations[task5.text] || 3), isIncreasing);
                                task5.start_date = task5StartDate;
                                task5.end_date = task5EndDate;
                                gantt.refreshTask(task5Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task5Id] = task5.start_date;
                                endDates[task5Id] = task5.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                    
                                const task6Id = task5Id.replace("subtask_5", "subtask_6");
                                const task6 = gantt.getTask(task6Id);
                                if (task6) {
                                    const task6StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task5EndDate, 0), isIncreasing);
                                    const task6EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6StartDate, storedDurations[task6.text] || 3), isIncreasing);
                                    task6.start_date = task6StartDate;
                                    task6.end_date = task6EndDate;
                                    gantt.refreshTask(task6Id);
                                    // Guardar las nuevas fechas en localStorage
                                    startDates[task6Id] = task6.start_date;
                                    endDates[task6Id] = task6.end_date;
                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                    
                                    const task7Id = task6Id.replace("subtask_6", "subtask_7");
                                    const task7 = gantt.getTask(task7Id);
                                    if (task7) {
                                        const task7StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6EndDate, 0), isIncreasing);
                                        const task7EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7StartDate, storedDurations[task7.text] || 6), isIncreasing);
                                        task7.start_date = task7StartDate;
                                        task7.end_date = task7EndDate;
                                        gantt.refreshTask(task7Id);
                                        // Guardar las nuevas fechas en localStorage
                                        startDates[task7Id] = task7.start_date;
                                        endDates[task7Id] = task7.end_date;
                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    
                                        const task8Id = task7Id.replace("subtask_7", "subtask_8");
                                        const task8 = gantt.getTask(task8Id);
                                        if (task8) {
                                            const task8StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7EndDate, 0), isIncreasing);
                                            const task8EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8StartDate, storedDurations[task8.text] || 2), isIncreasing);
                                            task8.start_date = task8StartDate;
                                            task8.end_date = task8EndDate;
                                            gantt.refreshTask(task8Id);
                                            // Guardar las nuevas fechas en localStorage
                                            startDates[task8Id] = task8.start_date;
                                            endDates[task8Id] = task8.end_date;
                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    
                                            const task9Id = task8Id.replace("subtask_8", "subtask_9");
                                            const task9 =gantt.getTask(task9Id);
                                            if (task9) {
                                                const task9StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8EndDate, 0), isIncreasing);
                                                const task9EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9StartDate, storedDurations[task9.text] || 4), isIncreasing);
                                                task9.start_date = task9StartDate;
                                                task9.end_date = task9EndDate;
                                                gantt.refreshTask(task9Id);
                                                // Guardar las nuevas fechas en localStorage
                                                startDates[task9Id] = task9.start_date;
                                                endDates[task9Id] = task9.end_date;
                                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    
                                                const task10Id = task9Id.replace("subtask_9", "subtask_10");
                                                const task10 = gantt.getTask(task10Id);
                                                if (task10) {
                                                    const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9EndDate, 0), isIncreasing);
                                                    const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                                                    task10.start_date = task10StartDate;
                                                    task10.end_date = task10EndDate;
                                                    gantt.refreshTask(task10Id);
                                                    // Guardar las nuevas fechas en localStorage
                                                    startDates[task10Id] = task10.start_date;
                                                    endDates[task10Id] = task10.end_date;
                                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    
                                                    const task11Id = task10Id.replace("subtask_10", "subtask_11");
                                                    const task11 = gantt.getTask(task11Id);
                                                    if (task11) {
                                                        const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10EndDate, 0), isIncreasing);
                                                        const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                                                        task11.start_date = task11StartDate;
                                                        task11.end_date = task11EndDate;
                                                        gantt.refreshTask(task11Id);
                                                        // Guardar las nuevas fechas en localStorage
                                                        startDates[task11Id] = task11.start_date;
                                                        endDates[task11Id] = task11.end_date;
                                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                                        const task12Id = task11Id.replace("subtask_11", "subtask_12");
                                                        const task12 = gantt.getTask(task12Id);
                                                        if (task12) {
                                                            const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11EndDate, 0), isIncreasing);
                                                            const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                                            task12.start_date = task12StartDate;
                                                            task12.end_date = task12EndDate;
                                                            gantt.refreshTask(task12Id);
                                                            // Guardar las nuevas fechas en localStorage
                                                            startDates[task12Id] = task12.start_date;
                                                            endDates[task12Id] = task12.end_date;
                                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                                            // Actualización de subtask_16
                                                            const subtask16Id = task6Id.replace("subtask_6", "subtask_16");
                                                            const subtask16 = gantt.getTask(subtask16Id);
                                                            if (subtask16) {
                                                                subtask16.start_date = task6.end_date;
                                                                subtask16.end_date = calculateEndDateWithoutWeekends(subtask16.start_date, storedDurations[subtask16.text]);
                                                                gantt.refreshTask(subtask16Id);
                                                                startDates[subtask16Id] = subtask16.start_date;
                                                                endDates[subtask16Id] = subtask16.end_date;
                                                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
            
                                                                // Actualización de subtask_17
                                                                const subtask17Id = task10Id.replace("subtask_10", "subtask_17");
                                                                const subtask17 = gantt.getTask(subtask17Id);
                                                                if (subtask17) {
                                                                    subtask17.start_date = task10.end_date;
                                                                    subtask17.end_date = calculateEndDateWithoutWeekends(subtask17.start_date, storedDurations[subtask17.text]);
                                                                    gantt.refreshTask(subtask17Id);
                                                                    startDates[subtask17Id] = subtask17.start_date;
                                                                    endDates[subtask17Id] = subtask17.end_date;
                                                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                } 
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 2
            else if (taskId.includes("subtask_2")) {
            const task3Id = taskId.replace("subtask_2", "subtask_3");
            const task3 = gantt.getTask(task3Id);
            if (task3) {
                const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task3.text] || 5), isIncreasing);
                task3.start_date = newStartDate;
                task3.end_date = newEndDate;
                gantt.refreshTask(task3Id);
                // Guardar las nuevas fechas en localStorage
                startDates[task3Id] = task3.start_date;
                endDates[task3Id] = task3.end_date;
                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));


                const task4Id = task3Id.replace("subtask_3", "subtask_4");
                const task4 = gantt.getTask(task4Id);
                if (task4) {
                    const task4StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task3.end_date, 0), isIncreasing);
                    const task4EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task4StartDate, storedDurations[task4.text] || 2), isIncreasing);
                    task4.start_date = task4StartDate;
                    task4.end_date = task4EndDate;
                    gantt.refreshTask(task4Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task4Id] = task4.start_date;
                    endDates[task4Id] = task4.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task5Id = task4Id.replace("subtask_4", "subtask_5");
                    const task5 = gantt.getTask(task5Id);
                    if (task5) {
                        const task5StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task4.end_date, 0), isIncreasing);
                        const task5EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task5StartDate, storedDurations[task5.text] || 3), isIncreasing);
                        task5.start_date = task5StartDate;
                        task5.end_date = task5EndDate;
                        gantt.refreshTask(task5Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task5Id] = task5.start_date;
                        endDates[task5Id] = task5.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                        const task6Id = task5Id.replace("subtask_5", "subtask_6");
                        const task6 = gantt.getTask(task6Id);
                        if (task6) {
                            const task6StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task5.end_date, 0), isIncreasing);
                            const task6EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6StartDate, storedDurations[task6.text] || 3), isIncreasing);
                            task6.start_date = task6StartDate;
                            task6.end_date = task6EndDate;
                            gantt.refreshTask(task6Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task6Id] = task6.start_date;
                            endDates[task6Id] = task6.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                            const task7Id = task6Id.replace("subtask_6", "subtask_7");
                            const task7 = gantt.getTask(task7Id);
                            if (task7) {
                                const task7StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6.end_date, 0), isIncreasing);
                                const task7EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7StartDate, storedDurations[task7.text] || 6), isIncreasing);
                                task7.start_date = task7StartDate;
                                task7.end_date = task7EndDate;
                                gantt.refreshTask(task7Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task7Id] = task7.start_date;
                                endDates[task7Id] = task7.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                const task8Id = task7Id.replace("subtask_7", "subtask_8");
                                const task8 = gantt.getTask(task8Id);
                                if (task8) {
                                    const task8StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7.end_date, 0), isIncreasing);
                                    const task8EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8StartDate, storedDurations[task8.text] || 2), isIncreasing);
                                    task8.start_date = task8StartDate;
                                    task8.end_date = task8EndDate;
                                    gantt.refreshTask(task8Id);
                                    // Guardar las nuevas fechas en localStorage
                                    startDates[task8Id] = task8.start_date;
                                    endDates[task8Id] = task8.end_date;
                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                    const task9Id = task8Id.replace("subtask_8", "subtask_9");
                                    const task9 = gantt.getTask(task9Id);
                                    if (task9) {
                                        const task9StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8.end_date, 0), isIncreasing);
                                        const task9EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9StartDate, storedDurations[task9.text] || 4), isIncreasing);
                                        task9.start_date = task9StartDate;
                                        task9.end_date = task9EndDate;
                                        gantt.refreshTask(task9Id);
                                        // Guardar las nuevas fechas en localStorage
                                        startDates[task9Id] = task9.start_date;
                                        endDates[task9Id] = task9.end_date;
                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                        const task10Id = task9Id.replace("subtask_9", "subtask_10");
                                        const task10 = gantt.getTask(task10Id);
                                        if (task10) {
                                            const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9.end_date, 0), isIncreasing);
                                            const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                                            task10.start_date = task10StartDate;
                                            task10.end_date = task10EndDate;
                                            gantt.refreshTask(task10Id);
                                            // Guardar las nuevas fechas en localStorage
                                            startDates[task10Id] = task10.start_date;
                                            endDates[task10Id] = task10.end_date;
                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                            const task11Id = task10Id.replace("subtask_10", "subtask_11");
                                            const task11 = gantt.getTask(task11Id);
                                            if (task11) {
                                                const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                                                const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                                                task11.start_date = task11StartDate;
                                                task11.end_date = task11EndDate;
                                                gantt.refreshTask(task11Id);
                                                // Guardar las nuevas fechas en localStorage
                                                startDates[task11Id] = task11.start_date;
                                                endDates[task11Id] = task11.end_date;
                                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                                const task12Id = task11Id.replace("subtask_11", "subtask_12");
                                                const task12 = gantt.getTask(task12Id);
                                                if (task12) {
                                                    const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                                                    const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                                    task12.start_date = task12StartDate;
                                                    task12.end_date = task12EndDate;
                                                    gantt.refreshTask(task12Id);
                                                    // Guardar las nuevas fechas en localStorage
                                                    startDates[task12Id] = task12.start_date;
                                                    endDates[task12Id] = task12.end_date;
                                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                    
                                                    // Actualización de subtask_16
                                                    const subtask16Id = task6Id.replace("subtask_6", "subtask_16");
                                                    const subtask16 = gantt.getTask(subtask16Id);
                                                    if (subtask16) {
                                                        subtask16.start_date = task6.end_date;
                                                        subtask16.end_date = calculateEndDateWithoutWeekends(subtask16.start_date, storedDurations[subtask16.text]);
                                                        gantt.refreshTask(subtask16Id);
                                                        startDates[subtask16Id] = subtask16.start_date;
                                                        endDates[subtask16Id] = subtask16.end_date;
                                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
            
                                                        // Actualización de subtask_17
                                                        const subtask17Id = task10Id.replace("subtask_10", "subtask_17");
                                                        const subtask17 = gantt.getTask(subtask17Id);
                                                        if (subtask17) {
                                                            subtask17.start_date = task10.end_date;
                                                            subtask17.end_date = calculateEndDateWithoutWeekends(subtask17.start_date, storedDurations[subtask17.text]);
                                                            gantt.refreshTask(subtask17Id);
                                                            startDates[subtask17Id] = subtask17.start_date;
                                                            endDates[subtask17Id] = subtask17.end_date;
                                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            //SI LA SUBTAREA ACTUALIZADA ES LA 3
            else if (taskId.includes("subtask_3")) {
                
                const task4Id = taskId.replace("subtask_3", "subtask_4");
                const task4 = gantt.getTask(task4Id);
                if (task4) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task4.text] || 2), isIncreasing);
                    task4.start_date = newStartDate;
                    task4.end_date = newEndDate;
                    gantt.refreshTask(task4Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task4Id] = task4.start_date;
                    endDates[task4Id] = task4.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task5Id = task4Id.replace("subtask_4", "subtask_5");
                    const task5 = gantt.getTask(task5Id);
                    if (task5) {
                        const task5StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task4.end_date, 0), isIncreasing);
                        const task5EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task5StartDate, storedDurations[task5.text] || 3), isIncreasing);
                        task5.start_date = task5StartDate;
                        task5.end_date = task5EndDate;
                        gantt.refreshTask(task5Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task5Id] = task5.start_date;
                        endDates[task5Id] = task5.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                        const task6Id = task5Id.replace("subtask_5", "subtask_6");
                        const task6 = gantt.getTask(task6Id);
                        if (task6) {
                            const task6StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task5.end_date, 0), isIncreasing);
                            const task6EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6StartDate, storedDurations[task6.text] || 3), isIncreasing);
                            task6.start_date = task6StartDate;
                            task6.end_date = task6EndDate;
                            gantt.refreshTask(task6Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task6Id] = task6.start_date;
                            endDates[task6Id] = task6.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                            const task7Id = task6Id.replace("subtask_6", "subtask_7");
                            const task7 = gantt.getTask(task7Id);
                            if (task7) {
                                const task7StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6.end_date, 0), isIncreasing);
                                const task7EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7StartDate, storedDurations[task7.text] || 6), isIncreasing);
                                task7.start_date = task7StartDate;
                                task7.end_date = task7EndDate;
                                gantt.refreshTask(task7Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task7Id] = task7.start_date;
                                endDates[task7Id] = task7.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                const task8Id = task7Id.replace("subtask_7", "subtask_8");
                                const task8 = gantt.getTask(task8Id);
                                if (task8) {
                                    const task8StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7.end_date, 0), isIncreasing);
                                    const task8EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8StartDate, storedDurations[task8.text] || 2), isIncreasing);
                                    task8.start_date = task8StartDate;
                                    task8.end_date = task8EndDate;
                                    gantt.refreshTask(task8Id);
                                    // Guardar las nuevas fechas en localStorage
                                    startDates[task8Id] = task8.start_date;
                                    endDates[task8Id] = task8.end_date;
                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                    const task9Id = task8Id.replace("subtask_8", "subtask_9");
                                    const task9 = gantt.getTask(task9Id);
                                    if (task9) {
                                        const task9StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8.end_date, 0), isIncreasing);
                                        const task9EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9StartDate, storedDurations[task9.text] || 4), isIncreasing);
                                        task9.start_date = task9StartDate;
                                        task9.end_date = task9EndDate;
                                        gantt.refreshTask(task9Id);
                                        // Guardar las nuevas fechas en localStorage
                                        startDates[task9Id] = task9.start_date;
                                        endDates[task9Id] = task9.end_date;
                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                        const task10Id = task9Id.replace("subtask_9", "subtask_10");
                                        const task10 = gantt.getTask(task10Id);
                                        if (task10) {
                                            const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9.end_date, 0), isIncreasing);
                                            const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                                            task10.start_date = task10StartDate;
                                            task10.end_date = task10EndDate;
                                            gantt.refreshTask(task10Id);
                                            // Guardar las nuevas fechas en localStorage
                                            startDates[task10Id] = task10.start_date;
                                            endDates[task10Id] = task10.end_date;
                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                            const task11Id = task10Id.replace("subtask_10", "subtask_11");
                                            const task11 = gantt.getTask(task11Id);
                                            if (task11) {
                                                const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                                                const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                                                task11.start_date = task11StartDate;
                                                task11.end_date = task11EndDate;
                                                gantt.refreshTask(task11Id);
                                                // Guardar las nuevas fechas en localStorage
                                                startDates[task11Id] = task11.start_date;
                                                endDates[task11Id] = task11.end_date;
                                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                
                                                const task12Id = task11Id.replace("subtask_11", "subtask_12");
                                                const task12 = gantt.getTask(task12Id);
                                                if (task12) {
                                                    const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                                                    const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                                    task12.start_date = task12StartDate;
                                                    task12.end_date = task12EndDate;
                                                    gantt.refreshTask(task12Id);
                                                    // Guardar las nuevas fechas en localStorage
                                                    startDates[task12Id] = task12.start_date;
                                                    endDates[task12Id] = task12.end_date;
                                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                    
                                                    // Actualización de subtask_16
                                                    const subtask16Id = task6Id.replace("subtask_6", "subtask_16");
                                                    const subtask16 = gantt.getTask(subtask16Id);
                                                    if (subtask16) {
                                                        subtask16.start_date = task6.end_date;
                                                        subtask16.end_date = calculateEndDateWithoutWeekends(subtask16.start_date, storedDurations[subtask16.text]);
                                                        gantt.refreshTask(subtask16Id);
                                                        startDates[subtask16Id] = subtask16.start_date;
                                                        endDates[subtask16Id] = subtask16.end_date;
                                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
            
                                                        // Actualización de subtask_17
                                                        const subtask17Id = task10Id.replace("subtask_10", "subtask_17");
                                                        const subtask17 = gantt.getTask(subtask17Id);
                                                        if (subtask17) {
                                                            subtask17.start_date = task10.end_date;
                                                            subtask17.end_date = calculateEndDateWithoutWeekends(subtask17.start_date, storedDurations[subtask17.text]);
                                                            gantt.refreshTask(subtask17Id);
                                                            startDates[subtask17Id] = subtask17.start_date;
                                                            endDates[subtask17Id] = subtask17.end_date;
                                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            //SI LA SUBTAREA ACTUALIZADA ES LA 4
            else if (taskId.includes("subtask_4")) {

                const task5Id = taskId.replace("subtask_4", "subtask_5");
                const task5 = gantt.getTask(task5Id);
                if (task5) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task5.text] || 3), isIncreasing);
                    task5.start_date = newStartDate;
                    task5.end_date = newEndDate;
                    gantt.refreshTask(task5Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task5Id] = task5.start_date;
                    endDates[task5Id] = task5.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task6Id = task5Id.replace("subtask_5", "subtask_6");
                    const task6 = gantt.getTask(task6Id);
                    if (task6) {
                        const task6StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task5.end_date, 0), isIncreasing);
                        const task6EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6StartDate, storedDurations[task6.text] || 3), isIncreasing);
                        task6.start_date = task6StartDate;
                        task6.end_date = task6EndDate;
                        gantt.refreshTask(task6Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task6Id] = task6.start_date;
                        endDates[task6Id] = task6.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                        const task7Id = task6Id.replace("subtask_6", "subtask_7");
                        const task7 = gantt.getTask(task7Id);
                        if (task7) {
                            const task7StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6.end_date, 0), isIncreasing);
                            const task7EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7StartDate, storedDurations[task7.text] || 6), isIncreasing);
                            task7.start_date = task7StartDate;
                            task7.end_date = task7EndDate;
                            gantt.refreshTask(task7Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task7Id] = task7.start_date;
                            endDates[task7Id] = task7.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                            const task8Id = task7Id.replace("subtask_7", "subtask_8");
                            const task8 = gantt.getTask(task8Id);
                            if (task8) {
                                const task8StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7.end_date, 0), isIncreasing);
                                const task8EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8StartDate, storedDurations[task8.text] || 2), isIncreasing);
                                task8.start_date = task8StartDate;
                                task8.end_date = task8EndDate;
                                gantt.refreshTask(task8Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task8Id] = task8.start_date;
                                endDates[task8Id] = task8.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                const task9Id = task8Id.replace("subtask_8", "subtask_9");
                                const task9 = gantt.getTask(task9Id);
                                if (task9) {
                                    const task9StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8.end_date, 0), isIncreasing);
                                    const task9EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9StartDate, storedDurations[task9.text] || 4), isIncreasing);
                                    task9.start_date = task9StartDate;
                                    task9.end_date = task9EndDate;
                                    gantt.refreshTask(task9Id);
                                    // Guardar las nuevas fechas en localStorage
                                    startDates[task9Id] = task9.start_date;
                                    endDates[task9Id] = task9.end_date;
                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                    const task10Id = task9Id.replace("subtask_9", "subtask_10");
                                    const task10 = gantt.getTask(task10Id);
                                    if (task10) {
                                        const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9.end_date, 0), isIncreasing);
                                        const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                                        task10.start_date = task10StartDate;
                                        task10.end_date = task10EndDate;
                                        gantt.refreshTask(task10Id);
                                        // Guardar las nuevas fechas en localStorage
                                        startDates[task10Id] = task10.start_date;
                                        endDates[task10Id] = task10.end_date;
                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                        const task11Id = task10Id.replace("subtask_10", "subtask_11");
                                        const task11 = gantt.getTask(task11Id);
                                        if (task11) {
                                            const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                                            const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                                            task11.start_date = task11StartDate;
                                            task11.end_date = task11EndDate;
                                            gantt.refreshTask(task11Id);
                                            // Guardar las nuevas fechas en localStorage
                                            startDates[task11Id] = task11.start_date;
                                            endDates[task11Id] = task11.end_date;
                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                            const task12Id = task11Id.replace("subtask_11", "subtask_12");
                                            const task12 = gantt.getTask(task12Id);
                                            if (task12) {
                                                const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                                                const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                                task12.start_date = task12StartDate;
                                                task12.end_date = task12EndDate;
                                                gantt.refreshTask(task12Id);
                                                // Guardar las nuevas fechas en localStorage
                                                startDates[task12Id] = task12.start_date;
                                                endDates[task12Id] = task12.end_date;
                                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                                // Actualización de subtask_16
                                                const subtask16Id = task6Id.replace("subtask_6", "subtask_16");
                                                const subtask16 = gantt.getTask(subtask16Id);
                                                if (subtask16) {
                                                    subtask16.start_date = task6.end_date;
                                                    subtask16.end_date = calculateEndDateWithoutWeekends(subtask16.start_date, storedDurations[subtask16.text]);
                                                    gantt.refreshTask(subtask16Id);
                                                    startDates[subtask16Id] = subtask16.start_date;
                                                    endDates[subtask16Id] = subtask16.end_date;
                                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
            
                                                    // Actualización de subtask_17
                                                    const subtask17Id = task10Id.replace("subtask_10", "subtask_17");
                                                    const subtask17 = gantt.getTask(subtask17Id);
                                                    if (subtask17) {
                                                        subtask17.start_date = task10.end_date;
                                                        subtask17.end_date = calculateEndDateWithoutWeekends(subtask17.start_date, storedDurations[subtask17.text]);
                                                        gantt.refreshTask(subtask17Id);
                                                        startDates[subtask17Id] = subtask17.start_date;
                                                        endDates[subtask17Id] = subtask17.end_date;
                                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                } 
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 5
            else if (taskId.includes("subtask_5")) {

                const task6Id = taskId.replace("subtask_5", "subtask_6");
                const task6 = gantt.getTask(task6Id);
                if (task6) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task6.text] || 3), isIncreasing);
                    task6.start_date = newStartDate;
                    task6.end_date = newEndDate;
                    gantt.refreshTask(task6Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task6Id] = task6.start_date;
                    endDates[task6Id] = task6.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task7Id = task6Id.replace("subtask_6", "subtask_7");
                    const task7 = gantt.getTask(task7Id);
                    if (task7) {
                        const task7StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task6.end_date, 0), isIncreasing);
                        const task7EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7StartDate, storedDurations[task7.text] || 6), isIncreasing);
                        task7.start_date = task7StartDate;
                        task7.end_date = task7EndDate;
                        gantt.refreshTask(task7Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task7Id] = task7.start_date;
                        endDates[task7Id] = task7.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                        const task8Id = task7Id.replace("subtask_7", "subtask_8");
                        const task8 = gantt.getTask(task8Id);
                        if (task8) {
                            const task8StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7.end_date, 0), isIncreasing);
                            const task8EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8StartDate, storedDurations[task8.text] || 2), isIncreasing);
                            task8.start_date = task8StartDate;
                            task8.end_date = task8EndDate;
                            gantt.refreshTask(task8Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task8Id] = task8.start_date;
                            endDates[task8Id] = task8.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                            const task9Id = task8Id.replace("subtask_8", "subtask_9");
                            const task9 = gantt.getTask(task9Id);
                            if (task9) {
                                const task9StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8.end_date, 0), isIncreasing);
                                const task9EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9StartDate, storedDurations[task9.text] || 4), isIncreasing);
                                task9.start_date = task9StartDate;
                                task9.end_date = task9EndDate;
                                gantt.refreshTask(task9Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task9Id] = task9.start_date;
                                endDates[task9Id] = task9.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                const task10Id = task9Id.replace("subtask_9", "subtask_10");
                                const task10 = gantt.getTask(task10Id);
                                if (task10) {
                                    const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9.end_date, 0), isIncreasing);
                                    const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                                    task10.start_date = task10StartDate;
                                    task10.end_date = task10EndDate;
                                    gantt.refreshTask(task10Id);
                                    // Guardar las nuevas fechas en localStorage
                                    startDates[task10Id] = task10.start_date;
                                    endDates[task10Id] = task10.end_date;
                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                    const task11Id = task10Id.replace("subtask_10", "subtask_11");
                                    const task11 = gantt.getTask(task11Id);
                                    if (task11) {
                                        const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                                        const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                                        task11.start_date = task11StartDate;
                                        task11.end_date = task11EndDate;
                                        gantt.refreshTask(task11Id);
                                        // Guardar las nuevas fechas en localStorage
                                        startDates[task11Id] = task11.start_date;
                                        endDates[task11Id] = task11.end_date;
                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                        const task12Id = task11Id.replace("subtask_11", "subtask_12");
                                        const task12 = gantt.getTask(task12Id);
                                        if (task12) {
                                            const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                                            const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                            task12.start_date = task12StartDate;
                                            task12.end_date = task12EndDate;
                                            gantt.refreshTask(task12Id);
                                            // Guardar las nuevas fechas en localStorage
                                            startDates[task12Id] = task12.start_date;
                                            endDates[task12Id] = task12.end_date;
                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                            // Actualización de subtask_16
                                            const subtask16Id = task6Id.replace("subtask_6", "subtask_16");
                                            const subtask16 = gantt.getTask(subtask16Id);
                                            if (subtask16) {
                                                subtask16.start_date = task6.end_date;
                                                subtask16.end_date = calculateEndDateWithoutWeekends(subtask16.start_date, storedDurations[subtask16.text]);
                                                gantt.refreshTask(subtask16Id);
                                                startDates[subtask16Id] = subtask16.start_date;
                                                endDates[subtask16Id] = subtask16.end_date;
                                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
            
                                                // Actualización de subtask_17
                                                const subtask17Id = task10Id.replace("subtask_10", "subtask_17");
                                                const subtask17 = gantt.getTask(subtask17Id);
                                                if (subtask17) {
                                                    subtask17.start_date = task10.end_date;
                                                    subtask17.end_date = calculateEndDateWithoutWeekends(subtask17.start_date, storedDurations[subtask17.text]);
                                                    gantt.refreshTask(subtask17Id);
                                                    startDates[subtask17Id] = subtask17.start_date;
                                                    endDates[subtask17Id] = subtask17.end_date;
                                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                } 
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 6 
            else if (taskId.includes("subtask_6")) {

                const task7Id = taskId.replace("subtask_6", "subtask_7");
                const task7 = gantt.getTask(task7Id);
                if (task7) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task7.text] || 6), isIncreasing);
                    task7.start_date = newStartDate;
                    task7.end_date = newEndDate;
                    gantt.refreshTask(task7Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task7Id] = task7.start_date;
                    endDates[task7Id] = task7.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task8Id = task7Id.replace("subtask_7", "subtask_8");
                    const task8 = gantt.getTask(task8Id);
                    if (task8) {
                        const task8StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task7.end_date, 0), isIncreasing);
                        const task8EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8StartDate, storedDurations[task8.text] || 2), isIncreasing);
                        task8.start_date = task8StartDate;
                        task8.end_date = task8EndDate;
                        gantt.refreshTask(task8Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task8Id] = task8.start_date;
                        endDates[task8Id] = task8.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                        const task9Id = task8Id.replace("subtask_8", "subtask_9");
                        const task9 = gantt.getTask(task9Id);
                        if (task9) {
                            const task9StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8.end_date, 0), isIncreasing);
                            const task9EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9StartDate, storedDurations[task9.text] || 4), isIncreasing);
                            task9.start_date = task9StartDate;
                            task9.end_date = task9EndDate;
                            gantt.refreshTask(task9Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task9Id] = task9.start_date;
                            endDates[task9Id] = task9.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                            const task10Id = task9Id.replace("subtask_9", "subtask_10");
                            const task10 = gantt.getTask(task10Id);
                            if (task10) {
                                const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9.end_date, 0), isIncreasing);
                                const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                                task10.start_date = task10StartDate;
                                task10.end_date = task10EndDate;
                                gantt.refreshTask(task10Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task10Id] = task10.start_date;
                                endDates[task10Id] = task10.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                const task11Id = task10Id.replace("subtask_10", "subtask_11");
                                const task11 = gantt.getTask(task11Id);
                                if (task11) {
                                    const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                                    const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                                    task11.start_date = task11StartDate;
                                    task11.end_date = task11EndDate;
                                    gantt.refreshTask(task11Id);
                                    // Guardar las nuevas fechas en localStorage
                                    startDates[task11Id] = task11.start_date;
                                    endDates[task11Id] = task11.end_date;
                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                    const task12Id = task11Id.replace("subtask_11", "subtask_12");
                                    const task12 = gantt.getTask(task12Id);
                                    if (task12) {
                                        const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                                        const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                        task12.start_date = task12StartDate;
                                        task12.end_date = task12EndDate;
                                        gantt.refreshTask(task12Id);
                                        // Guardar las nuevas fechas en localStorage
                                        startDates[task12Id] = task12.start_date;
                                        endDates[task12Id] = task12.end_date;
                                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                        // Actualización de subtask_16
                                        const subtask16Id = task6Id.replace("subtask_6", "subtask_16");
                                        const subtask16 = gantt.getTask(subtask16Id);
                                        if (subtask16) {
                                            subtask16.start_date = task6.end_date;
                                            subtask16.end_date = calculateEndDateWithoutWeekends(subtask16.start_date, storedDurations[subtask16.text]);
                                            gantt.refreshTask(subtask16Id);
                                            startDates[subtask16Id] = subtask16.start_date;
                                            endDates[subtask16Id] = subtask16.end_date;
                                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
            
                                            // Actualización de subtask_17
                                            const subtask17Id = task10Id.replace("subtask_10", "subtask_17");
                                            const subtask17 = gantt.getTask(subtask17Id);
                                            if (subtask17) {
                                                subtask17.start_date = task10.end_date;
                                                subtask17.end_date = calculateEndDateWithoutWeekends(subtask17.start_date, storedDurations[subtask17.text]);
                                                gantt.refreshTask(subtask17Id);
                                                startDates[subtask17Id] = subtask17.start_date;
                                                endDates[subtask17Id] = subtask17.end_date;
                                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                } 
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 7    
            else if (taskId.includes("subtask_7")) {

                const task8Id = taskId.replace("subtask_7", "subtask_8");
                const task8 = gantt.getTask(task8Id);
                if (task8) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task8.text] || 2), isIncreasing);
                    task8.start_date = newStartDate;
                    task8.end_date = newEndDate;
                    gantt.refreshTask(task8Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task8Id] = task8.start_date;
                    endDates[task8Id] = task8.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task9Id = task8Id.replace("subtask_8", "subtask_9");
                    const task9 = gantt.getTask(task9Id);
                    if (task9) {
                        const task9StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task8.end_date, 0), isIncreasing);
                        const task9EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9StartDate, storedDurations[task9.text] || 4), isIncreasing);
                        task9.start_date = task9StartDate;
                        task9.end_date = task9EndDate;
                        gantt.refreshTask(task9Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task9Id] = task9.start_date;
                        endDates[task9Id] = task9.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                        const task10Id = task9Id.replace("subtask_9", "subtask_10");
                        const task10 = gantt.getTask(task10Id);
                        if (task10) {
                            const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9.end_date, 0), isIncreasing);
                            const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                            task10.start_date = task10StartDate;
                            task10.end_date = task10EndDate;
                            gantt.refreshTask(task10Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task10Id] = task10.start_date;
                            endDates[task10Id] = task10.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                            const task11Id = task10Id.replace("subtask_10", "subtask_11");
                            const task11 = gantt.getTask(task11Id);
                            if (task11) {
                                const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                                const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                                task11.start_date = task11StartDate;
                                task11.end_date = task11EndDate;
                                gantt.refreshTask(task11Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task11Id] = task11.start_date;
                                endDates[task11Id] = task11.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                                const task12Id = task11Id.replace("subtask_11", "subtask_12");
                                const task12 = gantt.getTask(task12Id);
                                if (task12) {
                                    const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                                    const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                    task12.start_date = task12StartDate;
                                    task12.end_date = task12EndDate;
                                    gantt.refreshTask(task12Id);
                                    // Guardar las nuevas fechas en localStorage
                                    startDates[task12Id] = task12.start_date;
                                    endDates[task12Id] = task12.end_date;
                                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                                }
                            }
                        }
                    }
                } 
            }
            //SI LA SUBTAREA ACTUALIZADA ES LA 8 
            else if (taskId.includes("subtask_8")) {

                const task9Id = taskId.replace("subtask_8", "subtask_9");
                const task9 = gantt.getTask(task9Id);
                if (task9) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task9.text] || 4), isIncreasing);
                    task9.start_date = newStartDate;
                    task9.end_date = newEndDate;
                    gantt.refreshTask(task9Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task9Id] = task9.start_date;
                    endDates[task9Id] = task9.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task10Id = task9Id.replace("subtask_9", "subtask_10");
                    const task10 = gantt.getTask(task10Id);
                    if (task10) {
                        const task10StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task9.end_date, 0), isIncreasing);
                        const task10EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10StartDate, storedDurations[task10.text] || 4), isIncreasing);
                        task10.start_date = task10StartDate;
                        task10.end_date = task10EndDate;
                        gantt.refreshTask(task10Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task10Id] = task10.start_date;
                        endDates[task10Id] = task10.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                        

                        const task11Id = task10Id.replace("subtask_10", "subtask_11");
                        const task11 = gantt.getTask(task11Id);
                        if (task11) {
                            const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                            const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                            task11.start_date = task11StartDate;
                            task11.end_date = task11EndDate;
                            gantt.refreshTask(task11Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task11Id] = task11.start_date;
                            endDates[task11Id] = task11.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                            const task12Id = task11Id.replace("subtask_11", "subtask_12");
                            const task12 = gantt.getTask(task12Id);
                            if (task12) {
                                const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                                const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                                task12.start_date = task12StartDate;
                                task12.end_date = task12EndDate;
                                gantt.refreshTask(task12Id);
                                // Guardar las nuevas fechas en localStorage
                                startDates[task12Id] = task12.start_date;
                                endDates[task12Id] = task12.end_date;
                                localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                                localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                            }
                        }
                    }
                }
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 9 
            else if (taskId.includes("subtask_9")) {

                const task10Id = taskId.replace("subtask_9", "subtask_10");
                const task10 = gantt.getTask(task10Id);
                if (task10) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task10.text] || 4), isIncreasing);
                    task10.start_date = newStartDate;
                    task10.end_date = newEndDate;
                    gantt.refreshTask(task10Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task10Id] = task10.start_date;
                    endDates[task10Id] = task10.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task11Id = task10Id.replace("subtask_10", "subtask_11");
                    const task11 = gantt.getTask(task11Id);
                    if (task11) {
                        const task11StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task10.end_date, 0), isIncreasing);
                        const task11EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11StartDate, storedDurations[task11.text] || 1), isIncreasing);
                        task11.start_date = task11StartDate;
                        task11.end_date = task11EndDate;
                        gantt.refreshTask(task11Id);    
                        // Guardar las nuevas fechas en localStorage
                        startDates[task11Id] = task11.start_date;
                        endDates[task11Id] = task11.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                        const task12Id = task11Id.replace("subtask_11", "subtask_12");
                        const task12 = gantt.getTask(task12Id);
                        if (task12) {
                            const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                            const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                            task12.start_date = task12StartDate;
                            task12.end_date = task12EndDate;
                            gantt.refreshTask(task12Id);
                            // Guardar las nuevas fechas en localStorage
                            startDates[task12Id] = task12.start_date;
                            endDates[task12Id] = task12.end_date;
                            localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                            localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                        }
                    }
                } 
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 10    
            else if (taskId.includes("subtask_10")) {

                const task11Id = taskId.replace("subtask_10", "subtask_11");
                const task11 = gantt.getTask(task11Id);
                if (task11) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task11.text] || 1), isIncreasing);
                    task11.start_date = newStartDate;
                    task11.end_date = newEndDate;
                    gantt.refreshTask(task11Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task11Id] = task11.start_date;
                    endDates[task11Id] = task11.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task12Id = task11Id.replace("subtask_11", "subtask_12");
                    const task12 = gantt.getTask(task12Id);
                    if (task12) {
                        const task12StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task11.end_date, 0), isIncreasing);
                        const task12EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task12StartDate, storedDurations[task12.text] || 2), isIncreasing);
                        task12.start_date = task12StartDate;
                        task12.end_date = task12EndDate;
                        gantt.refreshTask(task12Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task12Id] = task12.start_date;
                        endDates[task12Id] = task12.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                    }
                } 
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 11
            else if (taskId.includes("subtask_11")) {

                const task12Id = taskId.replace("subtask_11", "subtask_12");
                const task12 = gantt.getTask(task12Id);
                if (task12) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task12.text] || 2), isIncreasing);
                    task12.start_date = newStartDate;
                    task12.end_date = newEndDate;
                    gantt.refreshTask(task12Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task12Id] = task12.start_date;
                    endDates[task12Id] = task12.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                }
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 12
            else if (taskId.includes("subtask_12")) {

            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 13
            else if (taskId.includes("subtask_13")) {
                const task14Id = taskId.replace("subtask_13", "subtask_14");
                const task14 = gantt.getTask(task14Id);
                if (task14) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task14.text] || 1), isIncreasing);
                    task14.start_date = newStartDate;
                    task14.end_date = newEndDate;
                    gantt.refreshTask(task14Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task14Id] = task14.start_date;
                    endDates[task14Id] = task14.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));

                    const task15Id = task14Id.replace("subtask_14", "subtask_15");
                    const task15 = gantt.getTask(task15Id);
                    if (task15) {
                        const task15StartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task14.end_date, 0), isIncreasing);
                        const task15EndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task15StartDate, storedDurations[task15.text] || 3), isIncreasing);
                        task15.start_date = task15StartDate;
                        task15.end_date = task15EndDate;
                        gantt.refreshTask(task15Id);
                        // Guardar las nuevas fechas en localStorage
                        startDates[task15Id] = task15.start_date;
                        endDates[task15Id] = task15.end_date;
                        localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                        localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                    }
                }

                // Actualización de subtask_16
                const subtask16Id = taskId.replace("subtask_13", "subtask_16");
                const subtask16 = gantt.getTask(subtask16Id);
                if (subtask16) {
                    subtask16.end_date = task.start_date; // La fecha de inicio de la subtarea 13 se convierte en la fecha de finalización de la subtarea 16
                    gantt.refreshTask(subtask16Id);
                    endDates[subtask16Id] = subtask16.end_date;
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                }

                // Actualización de subtask_17
                const subtask17Id = taskId.replace("subtask_13", "subtask_17");
                const subtask17 = gantt.getTask(subtask17Id);
                if (subtask17) {
                    subtask17.end_date = task.start_date; // La fecha de inicio de la subtarea 13 se convierte en la fecha de finalización de la subtarea 17
                    gantt.refreshTask(subtask17Id);
                    endDates[subtask17Id] = subtask17.end_date;
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                }

                // Refresh subtasks 16 and 17 to ensure updates are applied immediately
                if (subtask16) {
                    gantt.updateTask(subtask16Id);
                }
                if (subtask17) {
                    gantt.updateTask(subtask17Id);
                }
            } 
            //SI LA SUBTAREA ACTUALIZADA ES LA 14
            else if (taskId.includes("subtask_14")) {

                const task15Id = taskId.replace("subtask_14", "subtask_15");
                const task15 = gantt.getTask(task15Id);
                if (task15) {
                    const newStartDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(task.end_date, 0), isIncreasing);
                    const newEndDate = adjustDateForWeekends(calculateEndDateWithoutWeekends(newStartDate, storedDurations[task15.text] || 3), isIncreasing);
                    task15.start_date = newStartDate;
                    task15.end_date = newEndDate;
                    gantt.refreshTask(task15Id);
                    // Guardar las nuevas fechas en localStorage
                    startDates[task15Id] = task15.start_date;
                    endDates[task15Id] = task15.end_date;
                    localStorage.setItem(storedStartDatesKey, JSON.stringify(startDates));
                    localStorage.setItem(storedEndDatesKey, JSON.stringify(endDates));
                }
            }
            //SI LA SUBTAREA ACTUALIZADA ES LA 15
            else if (taskId.includes("subtask_15")) {
                            
            }
                const parentTaskId = gantt.getTask(taskId).parent;
                    if (gantt.isTaskExists(parentTaskId)) {
                    updateParentDuration(parentTaskId);
                    }

            });

            //PARA MOSTRAR UN MENSAJE - REDUCIR DIAS SI ES NECESARIO
            function checkTaskDates() {
                const tasks = gantt.getTaskByTime();
                tasks.forEach(task => {
                    if (!task.parent) {
                        const parentIdealEndDate = new Date(task.original_end_date);
                        const subtasks = gantt.getChildren(task.id);
                        let isOutOfTime = false;
                        let daysToReduce = 0;

                        if (subtasks.length > 0) {
                            const lastSubtask = gantt.getTask(subtasks[subtasks.length - 1]);
                            const lastSubtaskIdealEndDate = gantt.calculateEndDate(lastSubtask.start_date, lastSubtask.duration);
                            lastSubtaskIdealEndDate.setDate(lastSubtaskIdealEndDate.getDate() - 1);
                            if (parentIdealEndDate < lastSubtaskIdealEndDate) {
                                isOutOfTime = true;
                                daysToReduce = calculateBusinessDaysBetween(parentIdealEndDate, lastSubtaskIdealEndDate);
                            }
                        }

                        const warningText = `Fuera de tiempo: Reduce ${daysToReduce} día(s)`;
                        const warningTextStyled = ` <small style='font-size: 0.7em; color: red;'>${warningText}</small>`;
                        
                        task.text = task.text.replace(/ <small style='font-size: 0.7em; color: red;'>Fuera de tiempo: Reduce \d+ día\(s\)<\/small>/, "");

                        if (isOutOfTime) {
                            task.text += warningTextStyled;
                        }

                        gantt.refreshTask(task.id);
                    }
                });
            }
            function calculateBusinessDaysBetween(startDate, endDate) {
                let count = 0;
                let currentDate = new Date(startDate);
                while (currentDate < endDate) {
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        count++;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return count;
            }

            gantt.attachEvent("onGanttRender", function() {
                checkTaskDates();
            });

            gantt.attachEvent("onAfterTaskAdd", function(id, item) {
                checkTaskDates();
            });

            gantt.attachEvent("onAfterTaskUpdate", function(id, item) {
                checkTaskDates();
            });

            gantt.attachEvent("onAfterTaskDelete", function(id, item) {
                checkTaskDates();
            });

            gantt.attachEvent("onLightboxSave", function(taskId, task, is_new){
                storedResponsible[task.id] = task.responsible;
                localStorage.setItem(storedResponsibleKey, JSON.stringify(storedResponsible));
                return true;
            });

            //PARA ESTABLECER AL RESPONSABLE DE LAS SUBTAREAS
            gantt.attachEvent("onLightbox", function(taskId) {
                const select = document.querySelector(".gantt_cal_ltext select");
                const task = gantt.getTask(taskId);

                if (task) {
                    let parentTask = null;
                    gantt.eachTask(function(taskItem) {
                        if (taskItem.id === task.parent) {
                            parentTask = taskItem;
                            return false;
                        }
                    });

                    if (parentTask) {
                        let grandparentTask = null;
                        gantt.eachTask(function(taskItem) {
                            if (taskItem.id === parentTask.parent) {
                                grandparentTask = taskItem;
                                return false;
                            }
                        });

                        let responsibleOptions = [];
                        if (grandparentTask && grandparentTask.responsible) {
                            responsibleOptions = taskResponsibles[grandparentTask.responsible] || [];
                        } else if (parentTask.responsible) {
                            responsibleOptions = taskResponsibles[parentTask.responsible] || [];
                        }

                        if (responsibleOptions.length > 0) {
                            select.innerHTML = "";
                            responsibleOptions.forEach(option => {
                                const newOption = document.createElement("option");
                                newOption.value = option;
                                newOption.text = option;
                                select.add(newOption);
                            });

                            // Seleccionar el responsable previamente seleccionado
                            if (task.responsible) {
                                select.value = task.responsible;
                            }
                        } else {
                            select.innerHTML = "";
                            const warningOption = document.createElement("option");
                            warningOption.value = "";
                            warningOption.text = "COLOCAR ÁREA EN TAREA PADRE";
                            select.add(warningOption);
                        }
                    } else {
                        select.innerHTML = "";
                        Object.keys(taskResponsibles).forEach(key => {
                            const newOption = document.createElement("option");
                            newOption.value = key;
                            newOption.text = key;
                            select.add(newOption);
                        });

                        // Seleccionar el responsable previamente seleccionado
                        if (task.responsible) {
                            select.value = task.responsible;
                        }
                    }
                } else {
                    select.innerHTML = "";
                    Object.keys(taskResponsibles).forEach(key => {
                        const newOption = document.createElement("option");
                        newOption.value = key;
                        newOption.text = key;
                        select.add(newOption);
                    });

                    // Seleccionar el responsable previamente seleccionado
                    if (task.responsible) {
                        select.value = task.responsible;
                    }
                }
            });
            gantt.parse({ data });
            gantt.templates.task_class = function(start, end, task) {
                return task.css;
            };
        };

        //PARA CAMBIAR DE COLO EL BOTON DE BLOQUEO 
        function toggleLock() {
            var button = document.getElementById("toggleLockButton");
            if (button.innerText === "B") {
                button.innerText = "D";
                button.classList.remove("green");
                button.classList.add("red");
            } else {
                button.innerText = "B";
                button.classList.remove("red");
                button.classList.add("green");
            }
        }
        // Establecer color inicial
        document.getElementById("toggleLockButton").classList.add("white");

    </script>
</body>
</html>
